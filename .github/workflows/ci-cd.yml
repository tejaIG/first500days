# CI/CD Pipeline for RAG Agent Monorepo
name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # Frontend Build and Lint
  frontend:
    name: Frontend (Next.js)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./apps/web
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          cd ../..
          npm ci
      
      - name: Lint
        run: npm run lint
      
      - name: Type check
        run: npx tsc --noEmit
      
      - name: Build
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: https://app-rag-agent-16515.azurewebsites.net

  # Backend Build, Lint and Test
  backend:
    name: Backend (FastAPI)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./apps/api
    
    strategy:
      matrix:
        python-version: ['3.11']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest pytest-asyncio
          pip install -r requirements.txt
      
      - name: Lint with flake8
        run: |
          # Stop on syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=venv,__pycache__,.env
          # Treat all other issues as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics --exclude=venv,__pycache__,.env
      
      - name: Check imports
        run: |
          python -c "from app.core.config import Settings; print('✓ Config imports OK')" || echo "⚠ Config import failed"
          python -c "from app.services.vector_store import get_search_client; print('✓ Vector store imports OK')" || echo "⚠ Vector store import failed"
          python -c "from app.services.agent import process_query; print('✓ Agent imports OK')" || echo "⚠ Agent import failed"
          python -c "from app.api.routes import router; print('✓ Routes imports OK')" || echo "⚠ Routes import failed"

  # Security Scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Deploy to Azure (only on main branch)
  deploy-azure:
    name: Deploy to Azure
    needs: [frontend, backend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Prepare deployment package
        run: |
          cd apps/api
          zip -r ../../api_deploy.zip . -x "*__pycache__*" "*venv*" "*.pyc"
      
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: 'app-rag-agent-16515'
          package: './api_deploy.zip'
      
      - name: Configure App Settings
        run: |
          az webapp config appsettings set \
            --resource-group rg-rag-agent-prod \
            --name app-rag-agent-16515 \
            --settings \
              GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" \
              AZURE_SEARCH_ENDPOINT="${{ secrets.AZURE_SEARCH_ENDPOINT }}" \
              AZURE_SEARCH_KEY="${{ secrets.AZURE_SEARCH_KEY }}" \
              AZURE_SEARCH_INDEX_NAME="rag-index" \
              SCM_DO_BUILD_DURING_DEPLOYMENT="true" \
              WEBSITES_PORT="8000"
      
      - name: Restart Web App
        run: |
          az webapp restart \
            --name app-rag-agent-16515 \
            --resource-group rg-rag-agent-prod
      
      - name: Health Check
        run: |
          echo "Waiting for app to start..."
          sleep 30
          curl -f https://app-rag-agent-16515.azurewebsites.net/health || echo "Health check failed"
